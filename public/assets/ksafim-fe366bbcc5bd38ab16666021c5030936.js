/**
 * Created by JetBrains WebStorm.
 * User: amit
 * Date: 3/21/12
 * Time: 10:27 PM
 * To change this template use File | Settings | File Templates.
 */
(function(a){function b(){e={pniya:Handlebars.compile(a("#pniya-template").html()),pniyaTable:Handlebars.compile(a("#pniya-table-template").html()),row:Handlebars.compile(a("#pniya-row-template").html())}}function c(){a("#bakasha_recv_date").bind("keydown",function(a){a.preventDefault()}).datepicker()}function d(){a(".add-row").live("click",function(){KsafimApi.addRow(a(this).closest(".pniya"))}),a("#divider").bind("mousedown",function(){console.log("mousedown"),a(document).bind("mousemove",g).bind("mouseup",function(){a(document).unbind("mousemove",g).unbind("mouseup",arguments.callee)})}),a(".start-filling").live("click",function(b){var c=a(this),d=c.closest(".pniya"),e=c.prev("input"),f=e.val();if(f==""||isNaN(Number(f))){a(".enter-number",d).css("display","inline"),b.preventDefault();return}f=Number(f),e.bind("keypress mousedown",function(){return!1}).addClass("disabled"),KsafimApi.addPniyaTable(d),KsafimApi.addRow(d),c.remove(),a(".enter-number",d).remove(),b.preventDefault()}),a("input").live("keypress",function(a){a.keyCode==13&&a.preventDefault()}),a("input.prat").live("change",function(){var b=a(this).closest("td").next(".prat-name");if(a(this).val().trim()!=""){var c=a(this).val()[0]=="0"&&a(this).val()[1]=="0"?a(this).val():"00"+a(this).val();a.get("/open-budget/"+c,function(a){b.text(a.haavara_name)})}}),a("ul.scans.untagged.unlogged").live("click",i),a(".sign-in").bind("click",i),a(".sign-out").bind("click",function(){KsafimApi.signOut()})}function g(b){var c=window.innerWidth-b.pageX;a(".photo").css("width",c),a(".form-wrap").css("right",c+8)}function h(){var b=a(".file_frame"),c=perform_acrobat_detection();c.acrobat?b.css({width:"100%",display:"block",height:"400px"}):b.css({width:"0",display:"none",height:"0"})}function i(){FB.getLoginStatus(function(a){a.status==="connected"?KsafimApi.signIn():FB.login(function(a){a.authResponse?KsafimApi.signIn(function(){KsafimApi.changeUser(a.authResponse.name),KsafimApi.enableUntaggedScans()}):console.log("User cancelled login or did not fully authorize.")})})}window.KsafimApi={createPniya:function(b){b||(b={});var c=a(e.pniya({id:f++}));return a(".pniyot").append(c),b.noAnimation?c:(c.hide(),c.fadeIn(800,function(){a(this).find("input").focus().bind("keypress",function(b){b.keyCode==13&&(a(this).next("button").click(),b.preventDefault())})}),c)},enableUntaggedScans:function(b){a("ul.scans.untagged")[b?"addClass":"removeClass"]("unlogged")},getUserData:function(){FB.api("/me",function(a){console.log("Good to see you, "+a.name+"."),console.dir(a)})},signIn:function(){a("header .connecting").addClass("active"),a("header .sign-in").addClass("connecting"),a.getJSON("/users/auth/facebook/callback",function(b){a("header .sign-in").removeClass("connecting"),a("header .connecting").removeClass("active"),b.status=="failure"?(alert("failure: "+b.reason),KsafimApi.changeUser(),KsafimApi.enableUntaggedScans(!0)):(KsafimApi.changeUser(b.extra.raw_info.name),KsafimApi.enableUntaggedScans())})},signOut:function(){a("header .disconnecting").addClass("active"),a("header .sign-out").addClass("connecting"),a.ajax({type:"delete",url:"/users/sign_out",success:function(){a("header .sign-out").removeClass("connecting"),a("header .disconnecting").removeClass("active"),KsafimApi.changeUser(),KsafimApi.enableUntaggedScans(!0)}})},changeUser:function(b){b?typeof b=="string"&&(a("header .user-name").text(b),a("header .hello-user-actions").addClass("active"),a("header .hello-user-actions-guest").removeClass("active")):(a("header .user-name").text(""),a("header .hello-user-actions").removeClass("active"),a("header .hello-user-actions-guest").addClass("active"))},addPniyaTable:function(b){a(e.pniyaTable({})).appendTo(b)},addRow:function(b){var c=b.attr("id").split("-")[1],d=b.data("rows");d?d++:d=1,b.data("rows",d);var f=a(e.row({pniya_id:c,id:d}));return f.appendTo(b.find(".pniya-table").children("tbody")),a(".prat",f).focus(),f}},a(function(){b(),c(),d(),h(),f=a("div[id^=pniya-]").length});var e,f})(jQuery);